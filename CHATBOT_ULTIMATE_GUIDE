
Claude Can handle complex questions like:

"Compare our revenue this month to last month and identify which customer segments are driving the growth"
"Show me customers who spent more than average but haven't purchased in 2 weeks"

# ü§ñ Chatbot Setup Guide for Jalikoi Analytics

## Overview

This guide covers 4 different chatbot implementations, from simple to advanced:

1. **Simple FAQ Chatbot** - Rule-based, no dependencies
2. **FastAPI Endpoint** - Integrates with your existing API
3. **AI-Powered Chatbot** - Uses Claude API for natural language
4. **React Frontend** - User interface component

---

## Option 1: Simple FAQ Chatbot (Easiest)

### Setup

```bash
# No additional dependencies needed
python chatbot_simple.py
```

### Features
- ‚úÖ Quick to implement
- ‚úÖ No API keys required
- ‚úÖ Basic queries only
- ‚ùå Limited natural language understanding

### Usage

```bash
python chatbot_simple.py
```

Example queries:
- "What's our total revenue?"
- "How many customers?"
- "Top customers"

---

## Option 2: FastAPI Chatbot Endpoint (Recommended)

### Setup

**1. Add to your API file:**

Add the code from `chatbot_api_endpoint.py` to your `jalikoi_analytics_api_ml.py`

**2. Restart your API:**

```bash
python jalikoi_analytics_api_ml.py
```

### API Endpoints

**POST /api/chatbot** - Send a chat message
```bash
curl -X POST "http://localhost:8000/api/chatbot" \
  -H "Content-Type: application/json" \
  -d '{"message": "What is our total revenue?", "user_id": "user123"}'
```

**GET /api/chatbot/history/{user_id}** - Get chat history
```bash
curl "http://localhost:8000/api/chatbot/history/user123?limit=20"
```

### Example Response

```json
{
  "success": true,
  "message": "Total revenue (last 30 days): 15,234,567 RWF from 3,456 transactions",
  "data": {
    "total_revenue": 15234567,
    "transactions": 3456,
    "average": 4405.68
  }
}
```

### Supported Queries

- **Revenue**: "What's our revenue?", "Revenue today", "Average transaction"
- **Customers**: "How many customers?", "Top customers", "New customers"
- **Stations**: "Station performance", "Best station", "Top stations"
- **Trends**: "Show trends", "Revenue growth", "Compare weeks"
- **Churn**: "At-risk customers", "Churn predictions"
- **Segments**: "Customer segments"

---

## Option 3: AI-Powered Chatbot (Most Advanced)

### Prerequisites

```bash
# Install Anthropic SDK
pip install anthropic
```

### Setup

**1. Get Claude API Key:**
- Sign up at https://console.anthropic.com
- Create an API key

**2. Set Environment Variable:**

```bash
# Linux/Mac
export ANTHROPIC_API_KEY='your-api-key-here'

# Windows
set ANTHROPIC_API_KEY=your-api-key-here
```

**3. Run Chatbot:**

```bash
python chatbot_ai_powered.py
```

### Features

- ‚úÖ Natural language understanding
- ‚úÖ Context-aware conversations
- ‚úÖ Automatic database queries
- ‚úÖ Intelligent insights
- ‚úÖ Function calling

### Example Conversation

```
You: What's our revenue this month compared to last month?

Bot: Let me check that for you...
üîß Calling: get_database_stats({'start_date': '2025-10-01', 'end_date': '2025-10-31'})
üîß Calling: get_database_stats({'start_date': '2025-09-01', 'end_date': '2025-09-30'})

Bot: Your revenue this month (October 2025) is 18,567,234 RWF, which is 
15.3% higher than last month (September: 16,098,456 RWF). That's an 
increase of 2,468,778 RWF! üìà

The growth is being driven by:
- 234 new customers (+12%)
- Increased transaction frequency
- Higher average transaction value (4,678 RWF vs 4,234 RWF)

Would you like me to identify which customer segments are driving this growth?
```

### Cost Considerations

Claude API pricing (as of 2025):
- Input: ~$3 per million tokens
- Output: ~$15 per million tokens

Typical conversation: ~2,000 tokens = $0.03
Budget estimate: $30/month = ~1,000 conversations

---

## Option 4: React Frontend Component

### Setup

**1. Copy files to your React project:**

```bash
# Copy component
cp Chatbot.jsx /path/to/jalikoi-analytics-frontend/src/components/

# Copy CSS
cp Chatbot.css /path/to/jalikoi-analytics-frontend/src/components/
```

**2. Install dependencies (if needed):**

```bash
cd /path/to/jalikoi-analytics-frontend
npm install axios
```

**3. Add to your main App:**

```jsx
// In App.js
import Chatbot from './components/Chatbot';

function App() {
  return (
    <div className="App">
      {/* Your existing components */}
      
      {/* Add chatbot */}
      <Chatbot />
    </div>
  );
}
```

**4. Configure API URL:**

In `Chatbot.jsx`, update the API URL if needed:

```javascript
const API_URL = 'http://your-domain.com/api/chatbot';
// or for local development:
const API_URL = 'http://localhost:8000/api/chatbot';
```

### Features

- ‚úÖ Floating chat button
- ‚úÖ Expandable chat window
- ‚úÖ Quick question buttons
- ‚úÖ Message history
- ‚úÖ Loading states
- ‚úÖ Mobile responsive
- ‚úÖ Dark mode support

---

## Integration Guide

### Full Stack Setup (Recommended)

**Backend (FastAPI):**

1. Add chatbot endpoint code to `jalikoi_analytics_api_ml.py`
2. Restart API server
3. Test with curl or Postman

**Frontend (React):**

1. Add `Chatbot.jsx` and `Chatbot.css` to your React app
2. Import in `App.js`
3. Update API URL in component
4. Test in browser

### Quick Test

**Test Backend:**
```bash
curl -X POST "http://localhost:8000/api/chatbot" \
  -H "Content-Type: application/json" \
  -d '{"message": "What is our revenue?"}'
```

**Test Frontend:**
1. Start React app: `npm start`
2. Click chat button (bottom right)
3. Type: "What's our total revenue?"
4. Check response

---

## Customization

### Adding New Query Types

**In `ChatbotEngine._route_query()`:**

```python
# Add new intent
elif any(word in message for word in ['inventory', 'stock', 'fuel']):
    return self._handle_inventory_query(df)
```

**Add handler:**

```python
def _handle_inventory_query(self, df):
    total_liters = df['liter'].sum()
    return {
        'success': True,
        'message': f"Total fuel sold: {total_liters:,.2f} liters",
        'data': {'total_liters': float(total_liters)}
    }
```

### Customizing UI

Edit `Chatbot.css`:

```css
/* Change color scheme */
.chat-header {
  background: linear-gradient(135deg, #your-color-1, #your-color-2);
}

/* Change position */
.chatbot-container {
  bottom: 20px;  /* adjust */
  right: 20px;   /* adjust */
}
```

---

## Advanced Features

### 1. Add Authentication

```python
from fastapi import Depends, Header

async def verify_token(authorization: str = Header(None)):
    if not authorization or authorization != "Bearer YOUR_SECRET":
        raise HTTPException(status_code=401)
    return True

@app.post("/api/chatbot")
async def chatbot_query(
    chat_message: ChatMessage,
    authenticated: bool = Depends(verify_token)
):
    # ...
```

### 2. Add Rate Limiting

```bash
pip install slowapi
```

```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/api/chatbot")
@limiter.limit("10/minute")
async def chatbot_query(request: Request, chat_message: ChatMessage):
    # ...
```

### 3. Add Message Persistence

```python
# Save to database
def save_message(user_id, role, message):
    query = """
        INSERT INTO chat_history (user_id, role, message, timestamp)
        VALUES (%s, %s, %s, NOW())
    """
    with JalikoiDatabaseConnector(DB_CONFIG) as db:
        db.execute(query, (user_id, role, message))
```

### 4. Add Webhook Notifications

```python
import requests

def send_webhook(user_id, message):
    webhook_url = "https://your-webhook-url.com"
    payload = {
        "user_id": user_id,
        "message": message,
        "timestamp": datetime.now().isoformat()
    }
    requests.post(webhook_url, json=payload)
```

---

## Troubleshooting

### Issue: "ML features not available"
**Solution:** Train ML models first:
```bash
python train_ml_models.py
```

### Issue: "No data found"
**Solution:** Check database connection and date ranges

### Issue: API CORS errors in React
**Solution:** Add CORS middleware to FastAPI:
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### Issue: Claude API errors
**Solution:** 
1. Check API key is set correctly
2. Verify account has credits
3. Check error message for specific issue

---

## Production Deployment

### Backend

**1. Add to systemd service:**

Your existing `jalikoi-api.service` already includes the chatbot if you added the code to `jalikoi_analytics_api_ml.py`

**2. Restart service:**

```bash
sudo systemctl restart jalikoi-api
```

### Frontend

**1. Build React app:**

```bash
npm run build
```

**2. Deploy to server:**

```bash
sudo cp -r build/* /var/www/jalikoi/
```

### Environment Variables (Production)

Create `.env`:

```bash
# For AI chatbot
ANTHROPIC_API_KEY=your-production-key

# Database (if using .env)
DB_HOST=your-db-host
DB_USER=your-db-user
DB_PASSWORD=your-db-password
```

Load in Python:

```python
from dotenv import load_dotenv
import os

load_dotenv()
api_key = os.getenv('ANTHROPIC_API_KEY')
```

---

## Monitoring

### Track Usage

```python
# Add to chatbot endpoint
import logging

logging.info(f"Chatbot query from {user_id}: {message}")
```

### View Logs

```bash
# API logs
sudo journalctl -u jalikoi-api -f | grep "Chatbot"

# Save to file
sudo journalctl -u jalikoi-api > chatbot_logs.txt
```

### Analytics

```python
# Track in database
def log_chat_interaction(user_id, query, response_time):
    query = """
        INSERT INTO chatbot_analytics (user_id, query, response_time)
        VALUES (%s, %s, %s)
    """
    # ...
```

---

## Next Steps

1. **Start Simple**: Begin with FastAPI endpoint (Option 2)
2. **Add Frontend**: Implement React component
3. **Test Thoroughly**: Try various queries
4. **Upgrade to AI**: Add Claude integration when ready
5. **Monitor & Improve**: Track usage and add new features

---

## Resources

- FastAPI Docs: https://fastapi.tiangolo.com
- Anthropic Claude API: https://docs.anthropic.com
- React Documentation: https://react.dev

---

## Support

For issues or questions:
1. Check logs: `sudo journalctl -u jalikoi-api -f`
2. Test API directly with curl
3. Verify database connection
4. Check API documentation at http://localhost:8000/docs

---

**üéâ You're ready to build your chatbot!**

Choose the option that best fits your needs and follow the setup instructions above.